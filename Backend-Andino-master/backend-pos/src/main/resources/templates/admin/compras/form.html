<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Registrar Compra - Andino POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Andino POS</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/dashboard}">Dashboard</a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" class="d-flex">
                        <button type="submit" class="btn btn-outline-light">
                            <i class="fas fa-sign-out-alt"></i> Cerrar SesiÃ³n
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h1 class="mb-0">Registrar Nueva Compra</h1>
        </div>
        <div class="card-body">
            <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

            <form th:action="@{/admin/compras/save}" th:object="${compra}" method="post">
                <input type="hidden" th:field="*{id}" />

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fecha" class="form-label">Fecha:</label>
                        <input type="date" id="fecha" th:field="*{fecha}" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="pedidoProveedor" class="form-label">Pedido a Proveedor (Pendiente):</label>
                        <select id="pedidoProveedor" name="pedidoProveedorId" class="form-select" required>
                            <option value="">Seleccione un pedido</option>
                            <option th:each="pedido : ${pedidosPendientes}" th:value="${pedido.id}" th:text="'Pedido #' + ${pedido.id} + ' - ' + ${pedido.proveedor.nombre}"></option>
                        </select>
                    </div>
                </div>

                <hr>

                <h3>Detalles de la Compra</h3>
                <table class="table table-bordered" id="detallesTable">
                    <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Details will be populated by JavaScript based on selected PedidoProveedor -->
                    </tbody>
                </table>
                <button type="button" class="btn btn-success mb-3" id="addDetalle"><i class="fas fa-plus"></i> AÃ±adir Detalle Manualmente</button>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary me-2"><i class="fas fa-save"></i> Guardar Compra</button>
                    <a th:href="@{/admin/compras}" class="btn btn-secondary"><i class="fas fa-times"></i> Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        const pedidoProveedorSelect = document.getElementById('pedidoProveedor');
        const detallesTableBody = document.querySelector('#detallesTable tbody');
        const addDetalleButton = document.getElementById('addDetalle');
        const allProductos = /*[[${productos}]]*/ [];
        const productosMap = new Map(allProductos.map(p => [p.id, p.nombre]));

        // Function to add a new detail row
        function addRow(detalle = {}) {
            const newRow = detallesTableBody.insertRow();
            const rowIndex = detallesTableBody.rows.length - 1;

            // Product
            const productoCell = newRow.insertCell();
            const productoNombre = detalle.productoId ? productosMap.get(detalle.productoId) : '';
            productoCell.textContent = productoNombre;
            const inputProductoId = document.createElement('input');
            inputProductoId.type = 'hidden';
            inputProductoId.name = `detalles[${rowIndex}].producto.id`;
            inputProductoId.value = detalle.productoId || '';
            productoCell.appendChild(inputProductoId);

            // Quantity Input
            const cantidadCell = newRow.insertCell();
            const inputCantidad = document.createElement('input');
            inputCantidad.type = 'number';
            inputCantidad.step = '0.001';
            inputCantidad.className = 'form-control';
            inputCantidad.name = `detalles[${rowIndex}].cantidad`;
            inputCantidad.value = detalle.cantidad || '';
            inputCantidad.required = true;
            cantidadCell.appendChild(inputCantidad);

            // Unit Price Input
            const precioUnitarioCell = newRow.insertCell();
            const inputPrecioUnitario = document.createElement('input');
            inputPrecioUnitario.type = 'number';
            inputPrecioUnitario.step = '0.01';
            inputPrecioUnitario.className = 'form-control';
            inputPrecioUnitario.name = `detalles[${rowIndex}].precioUnitario`;
            inputPrecioUnitario.value = detalle.precioUnitario || '';
            inputPrecioUnitario.required = true;
            precioUnitarioCell.appendChild(inputPrecioUnitario);

            // Actions Cell
            const accionesCell = newRow.insertCell();
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger btn-sm remove-row';
            removeButton.innerHTML = '<i class="fas fa-trash"></i>';
            removeButton.onclick = function() {
                newRow.remove();
                updateRowIndexes();
            };
            accionesCell.appendChild(removeButton);
        }

        function updateRowIndexes() {
            Array.from(detallesTableBody.rows).forEach((row, index) => {
                row.querySelectorAll('input').forEach(element => {
                    const nameAttr = element.name;
                    if (nameAttr) {
                        element.name = nameAttr.replace(/detalles\[\d+\]/, `detalles[${index}]`);
                    }
                });
            });
        }

        // Event listener for adding a manual detail row
        addDetalleButton.addEventListener('click', () => addRow());

        // Event listener for PedidoProveedor selection change
        pedidoProveedorSelect.addEventListener('change', function() {
            const pedidoId = this.value;
            detallesTableBody.innerHTML = ''; // Clear existing details

            if (pedidoId) {
                fetch(`/api/pedidos/${pedidoId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.detalles.forEach(detalle => {
                            addRow(detalle);
                        });
                        updateRowIndexes();
                    });
            }
        });

        // Initial check if a pedido is pre-selected (e.g., in edit mode)
        if (pedidoProveedorSelect.value) {
            pedidoProveedorSelect.dispatchEvent(new Event('change'));
        }

        // Attach remove functionality to existing rows
        detallesTableBody.querySelectorAll('.remove-row').forEach(button => {
            button.onclick = function() {
                button.closest('tr').remove();
                updateRowIndexes();
            };
        });
    });
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>